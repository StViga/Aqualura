# Aquaria Guardian

## Обзор проекта
Aquaria Guardian помогает домашним аквариумистам быстро оценивать биозагрузку, риски несовместимости видов и планировать уход за своими банками. MVP ориентирован на один бесплатный аквариум, авторасчеты и напоминания с возможностью апгрейда тарифа.

- **Цель этапа**: За один сеанс пользователь регистрируется, создает аквариум, добавляет рыб из справочника, получает статус перенаселения, предупреждения по совместимости и расписание ухода с напоминаниями.
- **Основная аудитория**: Частный владелец аквариума от новичка до продвинутого любителя, ценящий наглядность вместо сложной терминологии.
- **Развертывание**: Next.js 16 (App Router) с Vercel-совместимыми serverless API.

## URLs и запуск
- **Локально**: `npm run dev` → http://localhost:3000
- **Продакшн**: готово к деплою на Vercel `npm run build && vercel deploy` (или `npm run build && vercel --prod`).

## Архитектура данных и доменные сущности
- **User**: идентификатор из Supabase Auth, email, authProvider (password/google), настройки уведомлений, активный тариф и лимиты.
- **Aquarium**: владелец, название, объем, статус биозагрузки (comfort/elevated/critical), статус совместимости, дата последнего расчета.
- **FishSpecies**: справочник видов с рекомендованным литражом, поведенческой категорией и коэффициентом бионагрузки.
- **AquariumStock**: связь аквариум ↔ вид, количество особей, размерный класс.
- **CareTask**: план обслуживания (тип, периодичность, ближайшая дата, статус, канал уведомлений, измеряемые параметры).
- **Subscription**: тариф, дата начала, лимит аквариумов.

## Интеграции
- Supabase Auth используется для email/password и Google OAuth. Клиент обращается к Supabase напрямую, сервер принимает токен через Bearer-заголовок и синхронизирует профиль пользователя с доменными сущностями.
- Supabase Service Role подключается на сервере (через `supabaseAdmin`) исключительно для валидации access-token и не попадает в браузер.

## Бизнес-логика
- **Биозагрузка**: суммируем рекомендованный объем каждого вида (количество × рекомендованный литраж) и сравниваем с реальным объемом. Диапазоны: до 60% комфорт, 61–100% повышенная нагрузка, >100% критическая.
- **Совместимость**: на основе поведенческих категорий выявляются пары конфликтующих видов с пояснениями.
- **План ухода**: базовый шаблон задач (подмена воды, тесты NO3/NO2/pH/GH/KH/TA/Cl2, кормление, наблюдение) с частотой по статусу биозагрузки. Позволяет отмечать выполнение и фиксировать измерения.
- **Уведомления**: каналы email/push/off с настройкой времени суток и опцией отключить напоминания о кормлении. Канал записывается в каждую задачу.
- **Тариф**: бесплатный тариф ограничен одним аквариумом. Попытка создать второй аквариум вызывает сценарий апгрейда (фиктивный апдейт подписки через API). Премиум увеличивает лимит.

## REST API (серверные Route Handlers)
- `GET /api/auth/session` – синхронизация доменного профиля по Supabase access-token.
- `GET /api/fish` – справочник видов.
- `GET/POST /api/aquariums` – список и создание (с тарифным ограничением).
- `GET/PATCH/DELETE /api/aquariums/:id` – карточка, обновление параметров, удаление.
- `POST /api/aquariums/:id/stock` – добавление вида.
- `PATCH/DELETE /api/aquariums/:id/stock/:stockId` – изменение количества и удаление вида.
- `GET /api/aquariums/:id/care-tasks` – план ухода.
- `POST /api/aquariums/:id/care-tasks/:taskId/complete` – отметка выполнения с измерениями.
- `GET/PATCH /api/notifications/settings` – глобальные настройки уведомлений.
- `GET /api/subscription` и `POST /api/subscription/upgrade` – состояние тарифа и «апгрейд».

Все защищённые эндпоинты ожидают заголовок `Authorization: Bearer <Supabase access token>`. Клиент добавляет заголовок автоматически, если пользователь авторизован в Supabase (email/password или Google).

## Клиентский интерфейс
- **Экран аутентификации**: переключение логин/регистрация, простая валидация, отображение ошибок.
- **Главный экран**: шапка с тарифом и пользователем, список аквариумов, карточка выбранного аквариума, блок совместимости, состав рыб, план ухода, модальные окна для настроек уведомлений и ввода результатов тестов.
- **Ограничения тарифа**: при превышении лимита показан блок с предложением апгрейда.
- **Состав и план ухода**: добавление/удаление видов, редактирование количества (через blur), отметка задач с измерениями параметров воды.

## Памятка по запуску в проде
1. Скопировать `.env.example` → `.env.local` и заполнить ключи Supabase/Google.
2. `npm install`
3. `npm run lint` – статический анализ (обязателен).
4. `npm run build` – проверка сборки.
5. `vercel deploy` (или подключить CI/CD Vercel).

## Следующие шаги (roadmap)
- Подключить реальную платежную систему для апгрейда тарифа.
- Добавить хранение данных в персистентном хранилище (например, Supabase/Postgres) вместо in-memory.
- Реализовать матрицу совместимости на более детализированных правилах (размер, регион, параметр воды).
- Интегрировать реальные пуш-сервисы (OneSignal, Firebase) и email провайдер (Resend/SendGrid).
- Создать страницу истории измерений параметров воды и визуализации трендов.
